{% extends "layout.html" %}
{% block title %}Riwayat - V-TRACK{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .custom-card { background-color: #E8EAF6; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .table-header { background-color: #4959C8; color: white; }
    .plate-badge { background-color: #673AB7; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; }
    .action-btn { border: none; border-radius: 5px; color: white !important; width: 35px; height: 35px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; margin: 0 2px; }
    .btn-view { background-color: #03A9F4; }
    .btn-delete { background-color: #F44336; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="custom-card">
        <h6><i class="fas fa-filter"></i> Filter & Export</h6>
        <hr>
        <form class="row g-3 align-items-end">
            <div class="col-md-3"><label class="form-label">Tanggal</label><input type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Nomor Plat</label><input type="text" class="form-control" placeholder="Cari plat nomor..."></div>
            <div class="col-md-2"><label class="form-label">Confidence</label><select class="form-select"><option>Semua</option></select></div>
            <div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Filter</button></div>
            <div class="col-md-3 d-flex justify-content-end">
                <button class="btn btn-success me-2">Export CSV</button>
                <button class="btn btn-success me-2">Export Excel</button>
                <button class="btn btn-secondary">Print</button>
            </div>
        </form>
    </div>

    <div class="custom-card">
        <h6>Riwayat Deteksi Plat Nomor</h6>
        <table id="riwayat-table" class="table table-striped" style="width:100%">
            <thead class="table-header">
                <tr>
                    <th>No</th>
                    <th>Foto</th>
                    <th>Nomor Plat</th>
                    <th>Waktu Mulai</th>
                    <th>Tujuan</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
    function getStatusBadge(status) {
        const icons = { 'Sesuai': 'fa-check-circle', 'Gagal': 'fa-times-circle', 'Perlu Cek Manual': 'fa-exclamation-triangle', 'Pending': 'fa-clock' };
        const colors = { 'Sesuai': 'success', 'Gagal': 'danger', 'Perlu Cek Manual': 'warning', 'Pending': 'secondary' };
        const icon = icons[status] || 'fa-question-circle';
        const color = colors[status] || 'secondary';
        return `<span class="badge text-bg-${color}"><i class="fas ${icon} me-1"></i> ${status}</span>`;
    }

    $(document).ready(function() {
        const table = $('#riwayat-table').DataTable({
            "order": [[0, "desc"]],
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json" },
            "ajax": { "url": "/api/riwayat", "dataSrc": "" },
            "columns": [
                { "data": "id" },
                { "data": "path_foto", "render": data => data ? `<img src="/${data}" style="width: 80px; border-radius: 4px;">` : '-', "orderable": false },
                { "data": "nomor_plat", "render": data => `<span class="plate-badge">${data}</span>` },
                { "data": "waktu_mulai" },
                { "data": "tujuan" },
                { "data": "status", "render": getStatusBadge },
                { "data": null, "orderable": false, "render": (data, type, row) => `
                    <a href="/pemantauan/${row.id}" class="action-btn btn-view" title="Pantau"><i class="fas fa-eye"></i></a>
                    <a href="/verifikasi/${row.id}" class="action-btn btn-delete" title="Verifikasi/Hapus"><i class="fas fa-trash-alt"></i></a>
                `}
            ]
        });
        setInterval(() => table.ajax.reload(null, false), 10000);
    });
</script>
{% endblock %}
