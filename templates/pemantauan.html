{% extends "layout.html" %}
{% block title %}Pemantauan - V-TRACK{% endblock %}

{% block styles %}
<style>
    .camera-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .camera-box { background-color: #F5C4C4; border: 4px solid white; border-radius: 12px; overflow: hidden; position: relative; aspect-ratio: 4 / 3; }
    .camera-box img { width: 100%; height: 100%; object-fit: cover; }
    .camera-box.detected { border-color: #4CAF50; }
    .camera-overlay { position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; padding: 10px; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="camera-grid">
    <div id="cam-feed-1" class="camera-box"><div class="camera-overlay">Kamera 1</div><img id="cam-img-1" src="/video_feed/1"></div>
    <div id="cam-feed-2" class="camera-box"><div class="camera-overlay">Kamera 2</div><img id="cam-img-2" src="/video_feed/2"></div>
    <div id="cam-feed-3" class="camera-box"><div class="camera-overlay">Kamera 3</div><img id="cam-img-3" src="/video_feed/3"></div>
    <div id="cam-feed-4" class="camera-box"><div class="camera-overlay">Kamera 4</div><img id="cam-img-4" src="/video_feed/4"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const PERJALANAN_ID = "{{ perjalanan_id }}";
    let intervalId;

    async function updateStatus() {
        try {
            const response = await fetch(`/api/pemantauan_status/${PERJALANAN_ID}`);
            if (!response.ok) return;
            const data = await response.json();
            const kameraTerdeteksi = data.kamera_terdeteksi;
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`cam-feed-${i}`).classList.toggle('detected', kameraTerdeteksi.includes(i));
            }
        } catch (error) { console.error("Error:", error); }
    }

    function stopAllFeeds() {
        for (let i = 1; i <= 6; i++) {
            const img = document.getElementById(`cam-img-${i}`);
            if (img) img.src = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateStatus();
        intervalId = setInterval(updateStatus, 3000);
        window.addEventListener('beforeunload', () => {
            clearInterval(intervalId);
            stopAllFeeds();
        });
    });
</script>
{% endblock %}
