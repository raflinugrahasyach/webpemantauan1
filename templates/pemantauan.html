<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemantauan Kendaraan - V-TRACK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fc;
        }
        .main-container { display: flex; height: 100vh; }
        .sidebar {
            background-color: #3b4ca6;
            width: 250px;
            flex-shrink: 0;
            color: white;
            padding-top: 20px;
        }
        .sidebar .logo { width: 180px; margin: 0 auto 30px auto; }
        .sidebar a {
            color: white; text-decoration: none; padding: 15px 30px;
            display: flex; align-items: center; font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .sidebar a:hover, .sidebar a.active { background-color: #4a6cf7; }
        .sidebar a i { margin-right: 15px; font-size: 20px; width: 25px; text-align: center; }
        .content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .info-panel {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .camera-feed {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 4px solid #dee2e6; /* Default border */
            transition: border-color 0.5s ease;
        }
        .camera-feed.checkpoint-success { border-color: #28a745; } /* Green for success */
        .camera-feed.checkpoint-next { border-color: #ffc107; } /* Yellow for next checkpoint */

        .camera-feed img { width: 100%; display: block; }
        .camera-feed-header {
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 8px 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <img src="{{ url_for('static', filename='pusri_logoooo.png') }}" alt="PUSRI Logo" class="logo" />
            <a href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="{{ url_for('riwayat') }}"><i class="fas fa-history"></i> Riwayat</a>
            <a href="{{ url_for('tambah_tujuan') }}"><i class="fas fa-plus-circle"></i> Tambah Tujuan</a>
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Log Out</a>
        </div>

        <div class="content">
            <div id="info-panel" class="info-panel">
                <h4 class="mb-3">Memuat Data Perjalanan...</h4>
                <p>Nomor Plat: <span id="nomor-plat">-</span></p>
                <p>Tujuan: <span id="tujuan">-</span></p>
                <p>Status: <span id="status" class="badge bg-secondary">-</span></p>
            </div>

            <div class="camera-grid" id="camera-grid">
                </div>
        </div>
    </div>
    
    <script>
        const perjalananId = {{ perjalanan_id }};

        function updateMonitoringStatus() {
            fetch(`/api/pemantauan_status/${perjalananId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('info-panel').innerHTML = `<h4 class="text-danger">${data.error}</h4>`;
                        return;
                    }
                    
                    const p = data.perjalanan;
                    document.getElementById('nomor-plat').textContent = p.nomor_plat;
                    document.getElementById('tujuan').textContent = p.tujuan;
                    const statusBadge = document.getElementById('status');
                    statusBadge.textContent = p.status;
                    statusBadge.className = `badge bg-${getStatusColor(p.status)}`;

                    const grid = document.getElementById('camera-grid');
                    grid.innerHTML = ''; // Clear previous grid

                    const rute = data.rute;
                    const terdeteksi = data.kamera_terdeteksi;
                    const terdeteksiIds = Object.keys(terdeteksi).map(id => parseInt(id));

                    // Tampilkan 4 kamera, atau sejumlah kamera di rute jika kurang dari 4
                    const totalCamerasToShow = Math.max(4, rute.length);

                    for (let i = 0; i < totalCamerasToShow; i++) {
                        const camId = rute[i];
                        let camHtml = '';

                        if(camId) {
                            let feedClass = 'camera-feed';
                            const nextCheckpointIndex = terdeteksiIds.length;
                            
                            if (terdeteksiIds.includes(camId)) {
                                feedClass += ' checkpoint-success';
                            } else if (i === nextCheckpointIndex && (p.status === 'Pending' || p.status === 'Perlu Cek Manual')) {
                                feedClass += ' checkpoint-next';
                            }

                            camHtml = `
                                <div class="${feedClass}">
                                    <div class="camera-feed-header">KAMERA ${camId}</div>
                                    <img src="/video_feed/${camId}" alt="Live Feed Kamera ${camId}">
                                </div>
                            `;
                        } else {
                             camHtml = `
                                <div class="camera-feed">
                                    <div class="camera-feed-header">KAMERA KOSONG</div>
                                    <img src="https://via.placeholder.com/640x480.png?text=Tidak+Ada+Kamera" alt="Placeholder">
                                </div>
                            `;
                        }
                        grid.insertAdjacentHTML('beforeend', camHtml);
                    }
                });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return 'warning';
                case 'Sesuai': return 'success';
                case 'Gagal': return 'danger';
                case 'Perlu Cek Manual': return 'info';
                default: return 'secondary';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateMonitoringStatus();
            setInterval(updateMonitoringStatus, 5000); // Refresh status setiap 5 detik
        });
    </script>
</body>
</html>